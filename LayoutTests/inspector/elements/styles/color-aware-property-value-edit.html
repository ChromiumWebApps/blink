<html>
<head>
<script src="../../../http/tests/inspector/inspector-test.js"></script>
<script src="../../../http/tests/inspector/elements-test.js"></script>
<script>

function test()
{
    WebInspector.inspectorView.showPanel("elements");

    InspectorTest.runTestSuite([
        function init(next)
        {
            InspectorTest.selectNodeAndWaitForStyles("inspected1", next);
        },

        function editKeywordAsOriginal(next)
        {
            startEditingAndDumpValue(WebInspector.Color.Format.Original, "border", next);
        },

        function editKeywordAsHex(next)
        {
            startEditingAndDumpValue(WebInspector.Color.Format.HEX, "border", next);
        },

        function editKeywordAsHSL(next)
        {
            startEditingAndDumpValue(WebInspector.Color.Format.HSL, "border", next);
        },

        function editKeywordAsRGB(next)
        {
            startEditingAndDumpValue(WebInspector.Color.Format.RGB, "border");
            InspectorTest.selectNodeAndWaitForStyles("inspected2", next);
        },

        function editHexAsOriginal(next)
        {
            startEditingAndDumpValue(WebInspector.Color.Format.Original, "color", next);
        },

        function editHexAsHex(next)
        {
            startEditingAndDumpValue(WebInspector.Color.Format.HEX, "color", next);
        },

        function editHexAsHSL(next)
        {
            startEditingAndDumpValue(WebInspector.Color.Format.HSL, "color", next);
        },

        function editHexAsRGB(next)
        {
            startEditingAndDumpValue(WebInspector.Color.Format.RGB, "color", next);
        },

        function editNewProperty(next)
        {
            var section = WebInspector.panels.elements.sidebarPanes.styles.sections[0][1];
            section.expand();

            treeElement = section.addNewBlankProperty(0);
            treeElement.startEditing();
            treeElement.nameElement.textContent = "border-color";
            treeElement.nameElement.dispatchEvent(InspectorTest.createKeyEvent("Enter"));
            InspectorTest.runAfterPendingDispatches(callbackName);

            function callbackName()
            {
                treeElement.valueElement.dispatchEvent(InspectorTest.createKeyEvent("U+001B"));
                treeElement.valueElement.textContent = "hsl(120, 100%, 25%)";
                treeElement.kickFreeFlowStyleEditForTest();
                InspectorTest.runAfterPendingDispatches(kicked);
            }

            function kicked()
            {
                treeElement.valueElement.dispatchEvent(InspectorTest.createKeyEvent("U+0009", false, false, true));
                InspectorTest.runAfterPendingDispatches(callbackBack);
            }

            function callbackBack()
            {
                treeElement.nameElement.dispatchEvent(InspectorTest.createKeyEvent("U+0009"));
                InspectorTest.runAfterPendingDispatches(callbackForward);
            }

            function callbackForward()
            {
                InspectorTest.addResult(treeElement.valueElement.textContent);
                next();
            }
        }
    ]);

    var format;
    WebInspector.settings.colorFormat = {
        get: function()
        {
            return format;
        }
    };

    function setFormat(newFormat)
    {
        format = newFormat;
        WebInspector.inspectorView.panel("elements").sidebarPanes.styles._colorFormatSettingChanged();
    }

    function startEditingAndDumpValue(format, propertyName, next)
    {
        setFormat(format);
        var treeElement = InspectorTest.getElementStylePropertyTreeItem(propertyName);
        treeElement.startEditing(treeElement.valueElement);
        InspectorTest.addResult(treeElement.valueElement.textContent);
        treeElement.valueElement.dispatchEvent(InspectorTest.createKeyEvent("U+001B"));
        if (next)
            next();
    }
}

</script>
</head>

<body onload="runTest()">
<p>
Tests that property value being edited uses the user-specified color format.
</p>

<div id="inspected1" style="border: 1px solid red">inspected1</div>
<div id="inspected2" style="color: #ffffee">inspected2</div>

</body>
</html>
